# 画板项目工具升级需求文档

> 版本：v1.0  
> 日期：2026-02-16  
> 作者：Claw

---

## 一、需求概述

本次升级主要针对绘图工具模块，共包含三个核心需求：

| 序号 | 需求项 | 优先级 | 预估工时 |
|------|--------|--------|----------|
| 1 | 矩形工具升级为形状工具 | P0 | 4h |
| 2 | 添加直线、曲线工具 | P0 | 6h |
| 3 | 添加油漆桶/填充工具 | P1 | 8h |

**总计预估工时：18h**

---

## 二、需求详情

### 2.1 矩形工具升级为形状工具

#### 2.1.1 功能描述

将现有的「矩形」工具升级为「形状」工具，支持绘制多种预设形状。形状类型通过配置区域（toolOption.vue）的下拉菜单选择。

#### 2.1.2 形状类型

| 形状名称 | key 值 | 说明 |
|----------|--------|------|
| 矩形 | `rectangle` | 现有功能迁移 |
| 圆形 | `circle` | 绘制正圆 |
| 椭圆 | `ellipse` | 绘制椭圆 |
| 三角形 | `triangle` | 等边三角形 |
| 菱形 | `diamond` | 菱形 |

#### 2.1.3 交互设计

**工具箱（toolBox.vue）**

- 将 `icon-rectangle` 图标改为 `icon-shapes` 或类似的通用形状图标
- 工具名称由「矩形」改为「形状」
- key 值由 `rectangle` 改为 `shapes`

**配置栏（toolOption.vue）**

当选择「形状」工具时，配置栏需显示以下选项：

```
┌─────────────────────────────────────────────────────────┐
│ [预览点] [线宽] [颜色] [形状类型▼] [填充模式▼]          │
│          2px    #000   矩形      实心/线框              │
└─────────────────────────────────────────────────────────┘
```

- **形状类型下拉框**：矩形 / 圆形 / 椭圆 / 三角形 / 菱形
- **填充模式下拉框**：实心(fill) / 线框(stroke) — 保留现有功能

#### 2.1.4 技术实现要点

1. **ITool 接口扩展**

```typescript
// src/interface/ITool.ts
export interface ITool {
  name: string;
  key: string;
  icon?: any;
  selected?: boolean;
  shapeType?: string; // 新增：当前选中的形状类型
}
```

2. **配置项扩展**

```typescript
// toolOption.vue 中的 option
{
  lineWidth: 2,
  color: "#000000",
  fillMode: "fill",     // 填充模式
  shapeType: "rectangle" // 形状类型（新增）
}
```

3. **绘制函数扩展**（app.help.ts）

新增以下绘制函数：

- `drawCircle()` - 绘制圆形
- `drawEllipse()` - 绘制椭圆
- `drawTriangle()` - 绘制三角形
- `drawDiamond()` - 绘制菱形

4. **绘制逻辑调整**（App.vue）

在 `setTool()` 中，根据 `options.value.shapeType` 调用对应的绘制函数。

#### 2.1.5 绘制算法说明

**圆形**：以起点为圆心，鼠标拖动距离为半径

```typescript
const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
context.arc(x1, y1, radius, 0, Math.PI * 2);
```

**椭圆**：以起点为中心，宽高由拖动距离决定

```typescript
context.ellipse(x1, y1, Math.abs(x2 - x1), Math.abs(y2 - y1), 0, 0, Math.PI * 2);
```

**三角形**：等边三角形，以拖动框为中心区域

```typescript
// 计算三角形三个顶点
const centerX = (x1 + x2) / 2;
const topY = Math.min(y1, y2);
const bottomY = Math.max(y1, y2);
// 顶点、左下、右下
```

**菱形**：以拖动框为中心，四个顶点

```typescript
// 上、右、下、左 四个顶点
```

---

### 2.2 添加直线、曲线工具

#### 2.2.1 功能描述

新增两种线条绘制工具：

- **直线工具**：绘制直线段
- **曲线工具**：绘制贝塞尔曲线

#### 2.2.2 工具箱变更

在 `toolList` 中新增：

```typescript
{ icon: "icon-line", key: "line", name: "直线", selected: false },
{ icon: "icon-curve", key: "curve", name: "曲线", selected: false },
```

#### 2.2.3 直线工具

**交互方式**：

- 鼠标按下确定起点
- 鼠标拖动实时预览直线
- 鼠标释放确定终点，绘制完成

**配置栏**：

```
┌─────────────────────────────────────────────────────────┐
│ [预览点] [线宽] [颜色]                                   │
└─────────────────────────────────────────────────────────┘
```

**绘制算法**：

```typescript
const drawLine = (
  context: CanvasRenderingContext2D,
  x1: number, y1: number,
  x2: number, y2: number
) => {
  context.beginPath();
  context.moveTo(x1, y1);
  context.lineTo(x2, y2);
  context.stroke();
  context.closePath();
};
```

**预览机制**：使用缓存画布（cache canvas）实现实时预览，与矩形工具类似。

#### 2.2.4 曲线工具（贝塞尔曲线）

**交互方式**：

采用**二次贝塞尔曲线**模式：

1. 第一次鼠标按下拖动：确定曲线的两个端点
2. 释放后显示控制点（可用小圆圈标识）
3. 拖动控制点调整曲线弯曲程度
4. 点击其他位置或按 Enter 键确认

或者采用简化的**三点击模式**：

1. 第一次点击：起点
2. 第二次点击：终点
3. 第三次点击：控制点（决定曲线弯曲方向和程度）

**建议**：考虑到项目已有交互模式，推荐采用**拖动预览模式**：

- 鼠标按下：确定起点
- 鼠标拖动：实时预览曲线（默认控制点在起点终点连线的中点附近）
- 鼠标释放：确定终点
- 再次拖动：调整控制点位置
- 双击或按 Enter：确认曲线

**配置栏**：

```
┌─────────────────────────────────────────────────────────┐
│ [预览点] [线宽] [颜色]                                   │
└─────────────────────────────────────────────────────────┘
```

**绘制算法**：

```typescript
const drawCurve = (
  context: CanvasRenderingContext2D,
  x1: number, y1: number,      // 起点
  x2: number, y2: number,      // 终点
  cpx: number, cpy: number     // 控制点
) => {
  context.beginPath();
  context.moveTo(x1, y1);
  context.quadraticCurveTo(cpx, cpy, x2, y2);
  context.stroke();
  context.closePath();
};
```

**状态管理**：

曲线工具需要额外的状态记录：

```typescript
interface CurveState {
  startPoint: { x: number; y: number } | null;
  endPoint: { x: number; y: number } | null;
  controlPoint: { x: number; y: number } | null;
  phase: 'start' | 'end' | 'control' | 'done';
}
```

#### 2.2.5 技术实现要点

1. **新增状态**：曲线工具需要多步骤状态管理
2. **预览机制**：直线和曲线都需要使用缓存画布实现预览
3. **历史记录**：曲线工具需要在最终确认后才保存历史（而非每步操作）

---

### 2.3 添加油漆桶/填充工具

#### 2.3.1 功能描述

油漆桶工具用于对封闭区域进行颜色填充，基于 **泛洪填充算法（Flood Fill）** 实现。

#### 2.3.2 工具箱变更

```typescript
{ icon: "icon-paint-bucket", key: "fill", name: "填充", selected: false },
```

#### 2.3.3 交互方式

- 点击画布上的任意位置，自动填充该位置相邻的同色区域
- 支持设置**颜色容差**（Tolerance），控制填充范围的敏感度

#### 2.3.4 配置栏设计

```
┌─────────────────────────────────────────────────────────┐
│ [颜色] [容差: 32]                                        │
│  #000   ━━━━━━━━○━━━━                                    │
└─────────────────────────────────────────────────────────┘
```

- **颜色选择器**：填充颜色
- **容差滑块**：0-100，默认 32
  - 容差越小，只填充非常接近的颜色
  - 容差越大，填充的颜色范围越宽

#### 2.3.5 算法实现

采用 **扫描线填充算法**（比逐像素泛洪更高效）：

```typescript
const floodFill = (
  imageData: ImageData,
  startX: number, startY: number,
  fillColor: [number, number, number, number],
  tolerance: number
) => {
  const data = imageData.data;
  const width = imageData.width;
  const height = imageData.height;
  
  // 获取起始点颜色
  const startIdx = (startY * width + startX) * 4;
  const startColor = [
    data[startIdx],
    data[startIdx + 1],
    data[startIdx + 2],
    data[startIdx + 3]
  ];
  
  // 如果起始颜色与填充颜色相同，无需填充
  if (colorMatch(startColor, fillColor, tolerance)) return;
  
  // 使用栈实现扫描线填充
  const stack: [number, number][] = [[startX, startY]];
  const visited = new Set<string>();
  
  while (stack.length > 0) {
    const [x, y] = stack.pop()!;
    
    // 边界检查
    if (x < 0 || x >= width || y < 0 || y >= height) continue;
    
    const key = `${x},${y}`;
    if (visited.has(key)) continue;
    
    const idx = (y * width + x) * 4;
    const currentColor = [data[idx], data[idx+1], data[idx+2], data[idx+3]];
    
    // 颜色匹配检查
    if (!colorMatch(currentColor, startColor, tolerance)) continue;
    
    visited.add(key);
    
    // 填充当前像素
    data[idx] = fillColor[0];
    data[idx + 1] = fillColor[1];
    data[idx + 2] = fillColor[2];
    data[idx + 3] = fillColor[3];
    
    // 添加相邻像素
    stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
  }
  
  return imageData;
};

// 颜色匹配函数（支持容差）
const colorMatch = (
  color1: number[],
  color2: number[],
  tolerance: number
): boolean => {
  return Math.abs(color1[0] - color2[0]) <= tolerance &&
         Math.abs(color1[1] - color2[1]) <= tolerance &&
         Math.abs(color1[2] - color2[2]) <= tolerance;
};
```

#### 2.3.6 技术实现要点

1. **获取像素数据**：

```typescript
const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
```

2. **填充后写回**：

```typescript
context.putImageData(imageData, 0, 0);
```

3. **性能优化**：
   - 使用 `Uint8ClampedArray` 直接操作像素
   - 使用扫描线优化而非逐像素递归
   - 对于大画布，考虑使用 Web Worker 避免阻塞主线程

4. **边界情况处理**：
   - 点击位置超出画布边界
   - 点击位置颜色与填充颜色相同
   - 填充开放区域（无边界）

#### 2.3.7 容差说明示例

| 容差值 | 效果 |
|--------|------|
| 0 | 只填充完全相同的颜色 |
| 32 | 填充相近颜色（默认推荐） |
| 64 | 填充较大范围的颜色差异 |
| 100 | 填充几乎所有相似颜色 |

---

## 三、数据结构变更

### 3.1 工具类型扩展

```typescript
// src/interface/ITool.ts
export interface ITool {
  name: string;
  key: string;
  icon?: any;
  selected?: boolean;
  // 新增（可选，仅形状工具使用）
  shapeType?: 'rectangle' | 'circle' | 'ellipse' | 'triangle' | 'diamond';
}
```

### 3.2 配置项扩展

```typescript
// 工具配置项类型
interface ToolOptions {
  lineWidth: number;
  color: string;
  // 形状工具
  fillMode?: 'fill' | 'stroke';
  shapeType?: 'rectangle' | 'circle' | 'ellipse' | 'triangle' | 'diamond';
  // 填充工具
  tolerance?: number; // 容差 0-100
}
```

### 3.3 工具列表更新

```typescript
// toolBox.vue
const toolList = ref<ITool[]>([
  { icon: "icon-pencil", key: "pencil", name: "铅笔", selected: true },
  { icon: "icon-clear-format", key: "eraser", name: "橡皮", selected: false },
  { icon: "icon-shapes", key: "shapes", name: "形状", selected: false },      // 升级
  { icon: "icon-line", key: "line", name: "直线", selected: false },          // 新增
  { icon: "icon-curve", key: "curve", name: "曲线", selected: false },        // 新增
  { icon: "icon-paint-bucket", key: "fill", name: "填充", selected: false },  // 新增
]);
```

---

## 四、UI 变更清单

### 4.1 toolBox.vue

| 变更项 | 原值 | 新值 |
|--------|------|------|
| 矩形工具图标 | `icon-rectangle` | `icon-shapes` |
| 矩形工具名称 | 矩形 | 形状 |
| 矩形工具 key | `rectangle` | `shapes` |
| 新增直线工具 | - | `{ icon: "icon-line", key: "line", name: "直线" }` |
| 新增曲线工具 | - | `{ icon: "icon-curve", key: "curve", name: "曲线" }` |
| 新增填充工具 | - | `{ icon: "icon-paint-bucket", key: "fill", name: "填充" }` |

### 4.2 toolOption.vue

| 工具类型 | 配置项 |
|----------|--------|
| 铅笔 | 线宽、颜色 |
| 橡皮 | 线宽 |
| 形状 | 线宽、颜色、**形状类型**、填充模式 |
| 直线 | 线宽、颜色 |
| 曲线 | 线宽、颜色 |
| 填充 | 颜色、**容差** |

---

## 五、文件变更清单

| 文件路径 | 变更类型 | 说明 |
|----------|----------|------|
| `src/interface/ITool.ts` | 修改 | 扩展工具接口 |
| `src/help/app.help.ts` | 修改 | 新增绘制函数 |
| `src/components/toolBox.vue` | 修改 | 更新工具列表 |
| `src/components/toolOption.vue` | 修改 | 新增配置项 UI |
| `src/App.vue` | 修改 | 更新工具逻辑 |

---

## 六、测试要点

### 6.1 形状工具测试

- [ ] 矩形、圆形、椭圆、三角形、菱形绘制正常
- [ ] 实心/线框模式切换正常
- [ ] 实时预览正常
- [ ] 撤销/重做正常

### 6.2 直线工具测试

- [ ] 直线绘制正常
- [ ] 实时预览正常
- [ ] 线宽、颜色配置生效

### 6.3 曲线工具测试

- [ ] 曲线绘制正常
- [ ] 控制点调整正常
- [ ] 多步骤交互流畅
- [ ] 确认/取消操作正常

### 6.4 填充工具测试

- [ ] 基础填充正常
- [ ] 容差参数生效
- [ ] 边界情况处理正常（开放区域、边界外点击）
- [ ] 大面积填充性能可接受
- [ ] 撤销/重做正常

---

## 七、风险与注意事项

1. **曲线工具交互复杂度**：需要仔细设计交互流程，避免用户困惑
2. **填充工具性能**：大面积填充可能引起卡顿，需测试优化
3. **历史记录**：曲线工具的多步骤操作在确认前不应保存历史
4. **图标资源**：需准备新的图标（icon-line, icon-curve, icon-shapes, icon-paint-bucket）

---

## 八、参考资料

- Canvas API: https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API
- 贝塞尔曲线: https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/bezierCurveTo
- 泛洪填充算法: https://en.wikipedia.org/wiki/Flood_fill

---

*文档结束*
